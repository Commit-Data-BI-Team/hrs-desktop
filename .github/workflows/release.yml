name: Release Desktop

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-mac:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run dist:mac -- --publish never
      - uses: actions/upload-artifact@v4
        with:
          name: release-mac
          path: |
            dist/*.dmg
            dist/*-mac.zip
            dist/latest-mac.yml

  build-win:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run dist:win:x64 -- --publish never
      - uses: actions/upload-artifact@v4
        with:
          name: release-win
          path: |
            dist/*.exe
            dist/latest.yml

  publish-release:
    runs-on: ubuntu-latest
    needs: [build-mac, build-win]
    env:
      GH_REPO: ${{ github.repository }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: release-mac
          path: dist-assets/release-mac
      - uses: actions/download-artifact@v4
        with:
          name: release-win
          path: dist-assets/release-win
      - name: Prepare release files
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME#v}"
          mkdir -p release-files

          cp "dist-assets/release-mac/HRS Desktop-${VERSION}-arm64.dmg" "release-files/HRS-Desktop-${VERSION}-arm64.dmg"
          cp "dist-assets/release-mac/HRS Desktop-${VERSION}.dmg" "release-files/HRS-Desktop-${VERSION}.dmg"
          cp "dist-assets/release-mac/HRS Desktop-${VERSION}-arm64-mac.zip" "release-files/HRS-Desktop-${VERSION}-arm64-mac.zip"
          cp "dist-assets/release-mac/HRS Desktop-${VERSION}-mac.zip" "release-files/HRS-Desktop-${VERSION}-mac.zip"
          cp "dist-assets/release-mac/latest-mac.yml" "release-files/latest-mac.yml"

          cp "dist-assets/release-win/HRS Desktop Setup ${VERSION}.exe" "release-files/HRS-Desktop-Setup-${VERSION}.exe"
          cp "dist-assets/release-win/latest.yml" "release-files/latest.yml"

          ls -lah release-files
      - name: Create release if missing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release view "$GITHUB_REF_NAME" -R "$GH_REPO" >/dev/null 2>&1 || \
          gh release create "$GITHUB_REF_NAME" -R "$GH_REPO" --title "$GITHUB_REF_NAME" --notes "Automated release $GITHUB_REF_NAME"
      - name: Keep only required assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME#v}"
          ALLOWED=(
            "HRS-Desktop-${VERSION}-arm64.dmg"
            "HRS-Desktop-${VERSION}.dmg"
            "HRS-Desktop-Setup-${VERSION}.exe"
            "HRS-Desktop-${VERSION}-arm64-mac.zip"
            "HRS-Desktop-${VERSION}-mac.zip"
            "latest-mac.yml"
            "latest.yml"
          )
          mapfile -t CURRENT < <(gh release view "$GITHUB_REF_NAME" -R "$GH_REPO" --json assets -q '.assets[].name')
          for name in "${CURRENT[@]}"; do
            keep=0
            for allowed in "${ALLOWED[@]}"; do
              if [[ "$name" == "$allowed" ]]; then
                keep=1
                break
              fi
            done
            if [[ $keep -eq 0 ]]; then
              gh release delete-asset "$GITHUB_REF_NAME" "$name" -R "$GH_REPO" -y
            fi
          done
      - name: Upload required assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "$GITHUB_REF_NAME" release-files/* -R "$GH_REPO" --clobber
